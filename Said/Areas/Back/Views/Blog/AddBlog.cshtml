@{
    ViewBag.Title = "Said后台管理系统 - 添加Blog";
    Layout = "~/Areas/Back/Views/Shared/_LayoutBack.cshtml";
}
<div class="page-header">
    <h2>添加文章&nbsp;&nbsp;<small>&gt;添加一篇文章</small></h2>
</div>
<ol class="breadcrumb">
    <li><a href="#">Home</a></li>
    <li><a href="#">文章管理</a></li>
    <li class="active">添加文章</li>
</ol>
<div class="main-context">
    <div class="modal fade" ms-controller="modal" id="blog-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">{{title}}</h4>
                </div>
                <div class="modal-body">{{body}}</div>
            </div>
        </div>
    </div>
    <form name="blogForm" method="post" ms-controller="blog" novalidate spellcheck="false">
        <div class="said-article">
            <div class="said-title-con">
                <input name="bTitle" ms-duplex="bTitle" class="said-title" ms-class="said-error:!bTitle.length" autocomplete="off" placeholder="文章标题" ms-change="saveTolocalStorage($event,this)" required />
            </div>
            <div class="said-context-content">
                <textarea name="bContext" class="said-context" ms-duplex="bContext" required>这中间有个said的水印图啊，在bootstrap见过一个【缩略语】的排版，非常奈斯啊啊！！！！</textarea>
            </div>
            <button class="btn btn-lg said-priview center-block" ms-click="preview(bContext)" type="button">预览</button>
        </div>
        @*ms-controller="defaultsDatas"*@
        <div class="row said-view-container">
            <div class="col-md-6">
                <div class="panel panel-default relative-container">
                    <div class="panel-heading">附加信息</div>
                    <div class="panel-body">
                        <div class="input-group" ms-controller="tagController">
                            <span class="input-group-addon">标签</span>
                            <input type="text" class="tag-input" ms-duplex="bTag" name="sTag" placeholder='标签，支持[tab]分隔' autocomplete="off" id="stag" ms-widget="groupInput" required />
                        </div>
                        <div class="input-group" ms-class="has-error:!classify.length" ms-controller="classifyController">
                            <span class="input-group-addon">分类</span>
                            <input type="text" name="classify" class="classify-input" ms-duplex="classify" placeholder="分类名称" autocomplete="off" ms-widget="groupInput" />
                        </div>
                    </div>
                </div>
                <div class="panel panel-default relative-container" ms-controller="uploadController">
                    <div ms-widget="upload,uploadImages"></div>
                    <div class="panel-heading">描述</div>
                    <div class="panel-body">
                        <div class="col-md-4">
                            <div class="music-img">
                                <div class="thumbnail">
                                    <img src="../../Content/Images/test-said-img.jpg" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <textarea class="said-dis" data-ng-model="article.sSummary" data-ng-class="{ 'said-error':saidForm.sSummary.$invalid&&(saidForm.sSummary.$dirty||article.dirty) }" name="sSummary" placeholder="简介[支持HTML]" required></textarea>
                            <div class="songOp-btn song-up-content">
                                <button ms-click="showUpload('uploadImages')" class="btn btn-danger songBtn" type="button">删除</button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="panel panel-default">
                    <div class="panel-heading ">可选信息</div>
                    <div class="panel-body">
                        <div class="input-group">
                            <span class="input-group-addon">文件</span>
                            <input type="text" name="sName" class="form-control" ms-duplex="bName" ms-change="asyncCheckExists(this,bName)" placeholder="文章发布的（文件）名称">
                        </div>
                        <div class="form-group">
                            <label>JavaScript</label>
                            <textarea rows="3" class="form-control" name="sJS" placeholder="自定义JavaScript" ms-duplex="bJS"></textarea>
                        </div>
                        <div class="form-group">
                            <label>CSS</label>
                            <textarea rows="3" class="form-control" name="sCSS" placeholder="自定义CSS" ms-duplex="bCSS"></textarea>
                        </div>
                        <div class="checkbox said-checkbox">
                            <label>
                                <input type="checkbox" ms-duplex-checked="bReprint" name="sReprint" />是否转载</label><label>
                                    <input type="checkbox" ms-duplex-checked="bIsTop" name="bIsTop" />是否置顶</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="submit-container">
            <div class="error-check">
                发布前会进行错误检测
            </div>
            <div class="progress">
                <div class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100" style="width: 22%">
                    <span class="sr-only">20% Complete</span>
                </div>
            </div>
            <button class="btn btn-lg said-submit center-block" id="submit" type="submit" data-ng-click="article.submitForm(saidForm)">发布</button>
            <!--data-ng-class="{'submit-lock':!saidForm.$valid}"-->
        </div>
    </form>
</div>

@section Css{
    <link href="@Url.Content("~/Content/Back/Style/addSaid.css")" rel="stylesheet" />
}
@section HeadJs{
    <script type="text/template" id="autoCompleteTemplate">
      <div class="queryInputBar" ms-widget="autoComplete,$,$acOption">
        @*<input type="text" name="classify" class="form-control" ms-duplex="classify" placeholder="分类名称" autocomplete="off" />*@
        <div class="querySelect" style="ms-css-display:filter.length">
            <a class="select-item" href="javascript:;" ms-repeat-item="filter" data-index="{{$index}}">{{item}}</a>
        </div>
      </div>
    </script>
    @*<script src="@Url.Content("~/Content/Back/JavaScript/avalon/plus/autoComplete.js")"></script>*@

}
@section FootJs{

    <script id="tplOpen" type="text/template">
<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>预览Blog - 你听，你静静听</title>
        <link href="/Content/Style/Global.css" rel="stylesheet" />
        <link href="/Content/Style/music.css" rel="stylesheet" />
        <link href="/Content/Back/JavaScript/syntaxhighlighter/styles/shCoreDefault.css" rel="stylesheet" />
    <replaceScript src="/Content/Back/JavaScript/syntaxhighlighter/scripts/shCore.js"></replaceScript>
    <replaceScript src="/Content/Back/JavaScript/syntaxhighlighter/scripts/shBrushJScript.js"></replaceScript>
    <replaceScript src="/Content/Back/JavaScript/syntaxhighlighter/scripts/shBrushCSharp.js"></replaceScript>
    <replaceScript src="/Content/Back/JavaScript/syntaxhighlighter/scripts/shBrushCss.js"></replaceScript>
    <replaceScript src="/Content/Back/JavaScript/syntaxhighlighter/scripts/shBrushSql.js"></replaceScript>
    </head>
        <body>
            <section id="said-page">
                <header id="header">
                    <div id="nav-logo">
                        <a class="logo" title="听说" href="javascript:;">
                            <img src="/Content/Images/Said.png" alt="said logo" /></a>
                    </div>
                    <nav id="nav">
                        <ul id="nav-flip">
                            <li><a href="javascript:;">首页</a>
                            </li>
                            <li><a href="javascript:;">blog</a></li>
                            <li><a href="javascript:;" class="nav-active">听说</a></li>
                            <li><a href="javascript:;">实验室</a></li>
                            <li><a href="javascript:;">关于</a></li>
                        </ul>
                        <div id="said-search-con" style="width: 50px;">
                            <div id="said-search">
                                <div id="said-search-btn" title="搜索"></div>
                                <form id="said-search-form">
                                    <input autocomplete="off" id="said-search-input" type="text" placeholder="搜索你感兴趣的" />
                                </form>
                            </div>
                        </div>
                        <span id="nav-hover" style="left: 140px;"></span>
                    </nav>
                </header>
                <section id="content">
                    <div class="content-bg">
                        <div class="content-bg-img" style="left: 0;"></div>
                    </div>
                    <section class="music-song">
                        <dl class="music-song-content">
                            <dt class="music-song-img">
                                <img src="/Content/Images/testImg-Paramore.Ps.jpg" alt="paramore" /></dt>
                            <dd class="music-song-info">
                                <ul>
                                    <li>
                                        <h2 class="music-song-name">The Only Exception The Only Exception The Only Exception</h2>
                                    </li>
                                    <li>
                                        <div class="music-song-summary"><a title="Artist" class="music-song-link" target="_blank" href="http://www.sogou.com/web?query=paramore&ie=utf8">Paramore</a></div>
                                        <div class="music-song-summary"><a title="Album" class="music-song-link" target="_blank" href="http://www.sogou.com/web?query=The+Only+Exception&ie=utf8">The Only Exception</a></div>
                                    </li>
                                </ul>
                            </dd>
                            <dd id="music-play" class="music-song-play">
                                <div class="music-play-status"><a href="javascript:;" id="said-player-play" class="play-btn player-play">播放</a></div>
                                <ul class="music-play-status">
                                    <li class="music-play-detail">
                                        <div class="music-time music-play-sound"><span>01:03</span><span>&nbsp;/&nbsp;03:42</span></div>
                                        <a class="music-like music-play-sound" href="javascript:;" title="我喜欢~么么哒">like</a><a class="music-volume music-play-sound" href="javascript:;" title="音量" id="said-play-volume"></a></li>
                                    <li>
                                        <div class="music-play-progress">
                                            <div class="play-progress" id="said-progress" style="width: 28%;"></div>
                                        </div>
                                    </li>
                                </ul>
                            </dd>
                        </dl>
                    </section>
                    <article class="music-content">
                        <h1 class="blog-title" id="title"></h1>
                        <section class="blog-content" id="context"></section>
                    </article>
                    <section class="blog-more-info">
                        <div class="blog-more-head">
                            <div class="blog-comment-txt"><span>评论(0)</span></div>
                            <ul class="blog-info">
                                <li class="blog-info-date"><time>2014/10/08 00:21:51</time></li>
                                <li class="blog-info-like" title="like"><span>1</span></li>
                                <li class="blog-info-PV" title="浏览"><span>1</span></li>
                            </ul>
                        </div>
                        <div class="blog-more-comment">
                            <div class="blog-comment-content">
                                <div class="blog-comment-bar">
                                    <div class="comment-portrait">
                                        <img alt="github" src="/Content/Images/github.png" />
                                    </div>
                                    <form action="/" class="comment-form">
                                        <ul class="blog-comment-info" style="">
                                            <li>
                                                <input placeholder="名称" /></li>
                                            <li>
                                                <input type="email" placeholder="Email" /></li>
                                            <li>
                                                <input type="url" placeholder="您的站点" /></li>
                                            <li>
                                                <input type="checkbox" id="comment-cookie" /><label for="comment-cookie">下次自动填写</label></li>
                                        </ul>
                                        <div class="comment-bar">
                                            <textarea name="comment" class="cmt-context" id="comment-context" placeholder="名称和Email（不会公开）必填，保存信息会保存这些信息，下次自动填充"></textarea><div class="comment-more-bar">
                                                <div class="comment-more-bg"></div>
                                                <input type="submit" class="submitLock ct-submit" id="comment-submit" value="提交评论" />
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </section>
                </section>
            </section>
            <footer id="footer">
                <section id="footer-content">
                    <dl>
                        <dt>推荐</dt>
                        <dd>
                            <ul class="footer-recm">
                                <li><a href="javascript:;">博客园 - 开发者的网上家园</a></li>
                                <li><a href="javascript:;">张鑫旭的个人博客</a></li>
                                <li><a href="javascript:;">司徒正美个人博客 - 博客园</a></li>
                                <li><a href="javascript:;">Github - linkFly</a></li>
                            </ul>
                        </dd>
                    </dl>
                    <dl>
                        <dt>许可</dt>
                        <dd>本站原创并且没有注明相关许可协议的内容，默认均采用<a href="javascript:;">《知识共享署名 3.0 中国大陆许可协议》</a>进行许可。非原创内容遵循原文许可协议。</dd>
                    </dl>
                    <dl>
                        <dt>联系方式</dt>
                        <dd>内容基本都是自己原创的，引用的地方都会给出相关引用，如有疏漏，联系方式：</dd>
                        <dd>linkFly6#live.com（#替换成@@）</dd>
                    </dl>
                    <div class="footer-copyright">©2015&nbsp;linkFly&nbsp;-&nbsp;Said:听说&nbsp;&nbsp;京ICP备13014059号</div>
                </section>
            </footer>
            <replaceScript type="text/javascript">     
                document.title = "预览Said -" + window.said.title;        
                document.getElementById("title").innerHTML = window.said.title;        
                document.getElementById("context").innerHTML = window.said.context;    
                SyntaxHighlighter.defaults["toolbar"] = false;        
                SyntaxHighlighter.defaults["collapse"] = false;       
                SyntaxHighlighter.all();
            </replaceScript>
        </body>
    </html>
    </script>


    <script type="text/javascript">
        require.config({
            baseUrl: '/Content/Back/JavaScript',
            paths: {
                'saidAdd': 'said/addSaid',
                'avalon': 'avalon/avalon.mobile.min',
                'groupInput': 'avalon/plus/groupInput',
                'upload': 'avalon/plus/upload',
                'showMsg': 'so/plug/showMsg',
                'markdown': 'showdown/showdown',
                'showDownThemeGithub': 'showdown/extensions/github'
            },
            packages: [
            {
                name: 'so',
                location: 'so',
                main: 'so'
            },
            {
                name: 'said',
                location: 'said',
                main: 'said'
            }],
            shim: {
                avalon: { exports: "avalon" },
                'showDownThemeGithub': ['markdown']//依赖showdown
            }
        });

        var Action = {
            song: '/Source/SaidSong',
            imagesSourceCenter: '@Url.Action("UploadBlogImg", "Source")',
            imgLocation: '@Url.Content("~/Source/Said/Images/")',
            music: '@Url.Action("UploadMusic", "Source")',
            existsSongFile: '@Url.Action("ExistsSongFileName", "Back")',
            existsSaidName: '@Url.Action("ExistsSaidFileName", "Back")',
            form: '@Url.Action("AddSaid", "Said")'
        },
        defaultValue = {
            tags: ['split'],
            classifyList: ['HTML', 'CSS', 'linkFly', 'C#', 'Bootstrap', 'JavaScript', 'XML']
        };
        require(['jquery', 'so', 'so/plug/search', 'avalon', 'showMsg', 'markdown', 'showDownThemeGithub', 'groupInput', 'upload'], function ($, so, Search, avalon, showMsg, showdown) {
            $(function () {
                var previewTemplent = document.getElementById('tplOpen').innerHTML.replace(/replaceScript/g, 'script'),
                    //showdown, github并非AMD库，requireJS只能保证当前这些库已经被加载完成，而不能得到加载完成的对象，所以仍然要去window环境下获取
                    showdown = window.Showdown,
                    converter = new showdown.converter({ extensions: ['github'] }),//页面markdown转换器=>来自showDown.js
                    preview = function () {
                        var previewWindow,//上一次打开的window
                                isSupport = true,//是否支持弹窗
                                supportError = function () {
                                    if (!isSupport)
                                        dialog('不支持该项操作', '<p>您的浏览器阻止了弹窗操作。</p><p>因为用户设置或者某些安全策略，浏览器或许会阻止弹窗操作。</p>');
                                    return isSupport;
                                };
                        return function (title, context) {
                            if (!supportError()) return false;
                            if (!previewWindow || previewWindow.closed)
                                previewWindow = window.open();
                            if (!previewWindow) {//没有权限弹窗
                                isSupport = false;
                                return supportError();
                            }
                            if (!title) {
                                title = '标题为空';
                            }
                            if (!context)
                                context = '文章正文为空';
                            /*
                            document.write只能输出到body，但HTML标签可以输出，但是输出没用，样式js都不解析执行..
                            所以访问window给它设置值来执行
                            */

                            previewWindow.document.open();
                            previewWindow.said = {
                                title: title.replace(/</g, '').replace(/>/g, ''),//标题
                                context: context//正文
                            };
                            previewWindow.document.write(previewTemplent);
                            previewWindow.document.close();
                            return true;
                        }
                    }(),
                    //利用avalon封装bootstrap modal组件
                    dialog = function (model) {
                        var vm = avalon.define('modal', function (vm) {
                            vm.title = vm.body = '';
                        });
                        return function (title, context) {
                            if (context == null && title != null)
                                vm.body = title;
                            else {
                                vm.title = title || '';
                                vm.body = context || '';
                            }
                            return model.modal('show');
                        };
                    }($('#blog-modal'));


                var vmBlog = avalon.define({
                    $id: 'blog',
                    bTitle: '',
                    bTag: '',
                    bSummary: '',
                    bReprint: '',
                    bScript: '',
                    bIsTop: '',
                    bHTML: '',
                    bCSS: '',
                    bContext: '',
                    bImg: '',
                    bName: '',
                    classify: 'linkFly',
                    $skipArray: ['bTag', 'bImg'],
                    //保存到本地数据库
                    saveTolocalStorage: function (name, value) {
                        
                    },
                    //预览
                    preview: function (markdownCode) {
                        if (!markdownCode.length) {
                            showMsg('请输入正文', showMsg.WARNING, 2000);
                            return;
                        }
                        preview('预览 - Blog', converter.makeHtml(markdownCode));
                    },
                    //异步检测文件是否存在，应该不需要异步的吧..... - -
                    asyncCheckExists: function (elem, name) {
                        console.log(arguments);
                    },

                    check: function () {

                    },
                    save: function () {

                    }
                });

                //vmBlog.$watch('$all', function () {
                //    console.log(arguments);
                //});

                //tag
                avalon.define({
                    $id: 'tagController',
                    tags: defaultValue.tags,
                    groupInput: {
                        datas: defaultValue.classifyList,
                        multiple: true,
                        zIndex: 5,
                        values: new Array(4).join('bootstrap.').split('.')
                    }
                });
                //classify
                avalon.define({
                    $id: 'classifyController',
                    groupInput: {
                        datas: defaultValue.classifyList,
                        zIndex: 4,
                        custom: false
                        //classContaier: 'queryInputBar'
                    }
                });

                //upload
                avalon.define({
                    $id: 'uploadController',
                    showUpload: function (id) {
                        avalon.vmodels[id].visible = true;
                    },
                    upload: {
                        classFile: 'hidden-file',
                        name: 'testFile',
                        url: Action.imagesSourceCenter,
                        done: function (vm, data) {
                            if (!data.code) {
                                showMsg('服务器异常：' + data.msg, showMsg.ERROR, true);
                                //return true;
                            }
                            vmBlog.bImg = data.name;
                        },
                        fail: function (vm, data) {
                            showMsg('上传异常：' + data.msg, showMsg.ERROR, true);
                        }
                    }
                });

                //console.log(vmUpload);




                //var vmBlog = avalon.define('blog', function (vm) {
                //    vm.BTitle = '';
                //});
                avalon.scan();
                //console.dir(avalon.vmodels);
            });
        });
    </script>
}