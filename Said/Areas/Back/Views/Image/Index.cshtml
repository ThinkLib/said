@using Said.Common;
@{
    ViewBag.Title = "Index";
    Layout = "~/Areas/Back/Views/Shared/_LayoutBack.cshtml";
}

<div class="page-header">
    <h3>图片管理&nbsp;&nbsp;<small>&gt;&nbsp;管理每一张美轮美奂并且精致的图片</small><a href="javascript:;" id="said-help-btn" title="帮助"><i class="fa fa-question-circle"></i></a></h3>
</div>
<ol class="breadcrumb">
    <li><a href="#">Home</a></li>
    <li><a href="#">资源管理</a></li>
    <li class="active">图片管理</li>
</ol>
<div id="said-help" class="said-mask-content said-watermark">
    <ul>
        <li>Said生成的缩略图不能有<span class="keywords">透明背景</span>（因为缩略图最终生成是jpg格式的）</li>
        <li>上传的图片，最后会被裁剪为<span class="keywords">1.82</span>比例的图片</li>
        <li>上传的图片不允许超过<span class="keywords">1MB</span></li>
        <li>上传的音乐文件不允许超过<span class="keywords">6MB</span></li>
    </ul>
</div>
<div class="main-context">
    <div class="source-content" ms-controller="model">
        <div class="source-head">
            <div class="toolbar-left">
                <div class="btn-group">
                    <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">{{typeText||'全部'}} <span class="caret"></span></button>
                    <ul class="dropdown-menu">
                        <li><a href="javascript:;" title="选择系统分类下的图片" ms-click="select($event,0)">系统</a></li>
                        <li><a href="javascript:;" title="选择Blog分类下的图片" ms-click="select($event,1)">日志</a></li>
                        <li><a href="javascript:;" title="选择Said分类下的图片" ms-click="select($event,2)">Said</a></li>
                        <li><a href="javascript:;" title="选择Music分类下的图片" ms-click="select($event,3)">音乐</a></li>
                        <li><a href="javascript:;" title="选择Page分类下的图片" ms-click="select($event,5)">页面</a></li>
                        <li><a href="javascript:;" title="选择Other分类下的图片" ms-click="select($event,7)">其他</a></li>
                        <li role="separator" class="divider"></li>
                        <li><a href="javascript:;" title="尚未推出">实验室</a></li>
                    </ul>

                </div>
                <div class="btn btn-upload btn-default btn-sm">
                    <div style="z-index: 3;" class="upload-mask">
                        <span class="upload-text">&nbsp;&nbsp;&nbsp;&nbsp;上传图片&nbsp;&nbsp;&nbsp;&nbsp;</span>
                        <div role="progressbar" class="upload-progress" style="width: 20%;"></div>
                        <input type="file" />
                    </div>
                </div>
                <div class="said-toggle" ms-class="selected:multiple" title="是否多选" ms-click="toggleMultiple()"></div>
            </div>
            <div class="source-loading">
                <div class="loading-line" ms-visible="isLoading">
                    <span class="loading-dot"></span>
                    <span class="loading-dot"></span>
                    <span class="loading-dot"></span>
                    <span class="loading-dot"></span>
                    <span class="loading-dot"></span>
                </div>
            </div>
            <div class="toolbar-right">
                <span class="source-sum"><span class="selected-count">{{selectCount}}</span>&nbsp;/&nbsp;{{sum}}</span>
            </div>
        </div>
        <div class="source-context">
            <div class="source-body">
                <div ms-repeat-item="datas" class="source-item">
                    <!--ms-class="selected:item.selected"-->
                    <div class="item-img" style="background-image:url(/Source/Sys/Images/Thumbnail028620152702234207.jpg)" ms-css-background-image="'url(' + item.img + ')'"></div>
                    <div class="item-info">
                        <span class="img-name">{{item.name}}</span>
                        <a title="删除" class="fa fa-times item-delete" href="javascript:;" ms-live-click="deleteImage"></a>
                    </div>
                </div>
                @*<div data-id="cac2b7cb398c470296e69765bd2fdd51" class="source-item selected">
                        <div class="item-img" data-src="/Source/Sys/Images/Thumbnail028620152702234207.jpg" style="background-image:url(/Source/Sys/Images/Thumbnail028620152702234207.jpg)">
                        </div>
                        <div class="item-info">
                            <span class="img-name">196620151803225207.jpg</span>
                            <a title="删除" class="fa fa-times item-delete" data-name="196620151803225207.jpg" data-id="cac2b7cb398c470296e69765bd2fdd51" href="javascript:;"></a>
                        </div>
                    </div>*@
            </div>
            <nav class="source-footer">
                <ul class="pagination">
                    <!--ms-visible="total==0"-->
                    <li ms-if="pageIndex>1"><a href="javascript:;" aria-label="Previous"><span aria-hidden="true">«</span></a></li>
                    <li ms-if="pageIndex>2"><a href="javascript:;"><span>1</span></a></li>
                    <li ms-if="pageIndex>2"><span>...</span></li>
                    <li ms-repeat-index="pages">
                        <a ms-if="index!=pageIndex" href="javascript:;">{{index}}</a>
                        <span ms-if="index==pageIndex">{{index}}</span>
                    </li>
                    <li ms-visible="pageIndex < sumPage - 2 "><span>...</span></li>
                    <li ms-if="pageIndex < sumPage - 2 "><a href="javascript:;"><span>{{sumPage}}</span></a></li>
                    <li ms-visible="pageIndex != sumPage"><a href="javascript:;" aria-label="Next"><span aria-hidden="true">»</span></a></li>
                </ul>
            </nav>
        </div>
    </div>
    <div class="source-detail">
        <ul class="source-info">
            <li>Thumbnail069420152702232107.jpg</li>
            <li>2015-7-6 22:54:15</li>
            <li>1024MB</li>
            <li>系统图片</li>
            <li>被引用12次</li>
            <li class="text-center"><a href="javascript:;" class="btn btn-default">查看大图</a></li>
        </ul>
    </div>
</div>
@section Css{
    <link href="@Url.Content("~/Content/Back/Style/imagesCenter.css")" rel="stylesheet" />
}

@section FootJs{
    <script>

        var Action = {
            getImageList: '@Url.Action("GetImagesList", "Image")'
        },
            Source = {
                thumbnail: [
                    '@ConfigInfo.SourceSystemThumbnailPath',
                    '@ConfigInfo.SourceBlogThumbnailPath',
                    '@ConfigInfo.SourceMusicThumbnailPath',
                    '@ConfigInfo.SourceSaidThumbnailPath',
                    '@ConfigInfo.SourceIconsPath',
                    '@ConfigInfo.SourceSystemThumbnailPath',
                    '@ConfigInfo.SourceSystemThumbnailPath',
                    '@ConfigInfo.SourceSystemThumbnailPath'
                ],
                image: [
                    '@ConfigInfo.SourceSystemPath',
                    '@ConfigInfo.SourceBlogPath',
                    '@ConfigInfo.SourceMusicImagePath',
                    '@ConfigInfo.SourceSaidPath',
                    '@ConfigInfo.SourceIconsPath',
                    '@ConfigInfo.SourceSystemPath',
                    '@ConfigInfo.SourceSystemPath',
                    '@ConfigInfo.SourceSystemPath'
                ]

            };
        var ImageType = {
            System: 0,
            Blog: 1,
            Music: 2,
            Said: 3,
            Icon: 4,
            Page: 5,
            Lab: 6,
            Other: 7
        };
        require.config({
            baseUrl: '/Content/Back/JavaScript',
            paths: {
                'upload': 'so/plug/upload',
                'showMsg': 'so/plug/showMsg'
            },
            packages: [
            {
                name: 'so',
                location: 'so',
                main: 'so'
            },
            {
                name: 'said',
                location: 'said',
                main: 'said'
            }]
        });
        require(['jquery', 'avalon', 'so', 'upload', 'showMsg'], function ($, avalon, _, upload, showMsg) {
            $(function () {
                'use strict';
                var imageUrl = {
                    thumbnail: function (imgName, typeId) {
                        return (Source.thumbnail[typeId] || Source.thumbnail[0]) + imgName;
                    },
                    get: function (imgName, type) {
                        return (Source.image[typeId] || Source.image[0]) + imgName;
                    }
                };
                var vmModel = avalon.define({
                    $id: 'model',
                    select: function (e, typeId) {
                        vmModel.typeText = e.target.innerHTML;
                        vmModel.typeId = typeId;
                        vmModel.typeUrl = '/Source/Sys/Images/';
                    },
                    multiple: false,
                    typeId: '',
                    typeUrl: '',
                    typeText: '',
                    selectCount: 0,
                    sum: 0,
                    isLoading: false,
                    datas: [],
                    allDatas: [],//已经翻页加载过的数据就不要再加载了
                    toggleMultiple: function () {
                        vmModel.isLoading = vmModel.multiple = !vmModel.multiple;
                    },
                    deleteImage: function (e) {
                        console.log(arguments);
                    },
                    /*分页*/
                    limit: 12,//个数
                    offset: 0,//数据起点
                    pageIndex: 1,//当前页码
                    pages: ['1', '2', '3', '4', '5'],
                    sumPage: 0,//总页码
                    $skipArray: ['limit', 'offset'],
                    load: function (pageIndex) {
                        var self = this,
                            pages = [];
                        //检查datas里面有没有
                        if (pageIndex)
                            this.offset = parseInt(pageIndex / this.limit + 1);
                        said.ajax(Action.getImageList, {
                            limit: self.limit,
                            offset: self.offset
                        }).done(function (res) {
                            if (res.total <= 0) return;
                            self.sum = res.total;

                            self.sumPage = res.total % self.limit === 0 ? res.total / self.limit : parseInt(res.total / self.limit) + 1;
                            console.log(res);
                            vmModel.datas = res.datas.map(function (item, i) {
                                item.img = _.imgLoad.DEFAULTS.load;
                                _.imgLoad({
                                    src: imageUrl.thumbnail(item.name, item.type),
                                    done: function (url) {
                                        vmModel.datas[i].img = url;
                                    },
                                    fail: function (url) {
                                        vmModel.datas[i].img = url;
                                    }
                                });
                                return item;
                            });
                            //解析数据啦。。。
                        }).fail(function () {

                        });
                    }
                });
                vmModel.load();
                avalon.scan();
            });
        })
    </script>
}