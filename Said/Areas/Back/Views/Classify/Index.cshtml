@{
    ViewBag.Title = "Said后台 - 分类/标签管理";
    Layout = "~/Areas/Back/Views/Shared/_LayoutBack.cshtml";
    IList<Said.Models.Classify> Classifs = ViewData["Classify"] as List<Said.Models.Classify>;
}
<div class="page-header">
    <h2>标签/分类&nbsp;&nbsp;<small>&gt;标签/分类管理</small></h2>
</div>
<ol class="breadcrumb">
    <li><a href="javascript:;">Home</a></li>
    <li class="active">标签/分类</li>
</ol>
<div class="main-context">
    <div class="row">
        <div class="col-md-6">
            <div class="bs-table">
                <div class="navbar-form navbar-left table-tool" id="classToolbar">
                    <div class="data-form">
                        <div class="form-control iconInput">
                            <input type="text" class="input-icon" placeholder="添加一个新的分类" maxlength="20" />
                        </div>
                        <button type="submit" class="btn btn-info">添加</button>
                    </div>
                    <div class="data-form" style="display: none">
                        <div class="form-control iconInput">
                            @*<div class="upload-box">
                        <input type="file" class="hidden-upload" tabindex="-1" />
                        <img alt="100%x180" data-src="holder.js/100%x180" src="data:image/png;base64,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" data-holder-rendered="true" />
                    </div>*@
                            <input class="input-icon" placeholder="编辑分类" maxlength="20" />
                        </div>
                        <button type="submit" id="classify-btn-up" class="btn btn-warning" title="点击将会修改该分类">修改</button>
                        <button class="btn btn-info" id="classify-btn-cancel">取消</button>
                    </div>
                </div>
                <table id="classifyTable" data-toolbar="#classToolbar" class="table table-hover table-striped main-table" data-striped="true" data-show-refresh="true" data-show-columns="true" data-search="true" data-pagination="true"></table>
            </div>
        </div>
        <div class="col-md-6">
            <div class="bs-table">
                <div class="navbar-form navbar-right table-tool" role="search" id="tagsToolbar">
                    <div class="data-form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="添加一个新的标签" />
                        </div>
                        <button type="submit" class="btn btn-info">添加</button>
                    </div>
                    <div class="data-form" style="display: none;">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="添加一个新的标签" />
                        </div>
                        <button type="submit" class="btn btn-warning" title="点击将会修改该标签">修改</button>
                        <button type="submit" class="btn btn-info">取消</button>
                    </div>
                </div>
                <table id="tagsTable" class="table table-hover table-striped main-table" data-toolbar="#tagsToolbar" data-striped="true" data-show-refresh="true" data-show-columns="true" data-search="true" data-pagination="true"></table>
            </div>
        </div>
    </div>
</div>
@section Css{
    <link href="@Url.Content("~/Content/Back/Style/classify.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/Back/Plug/bootstrap-table/bootstrap-table.min.css")" rel="stylesheet" />
}
@section FootJs{
    @*<script src="@Url.Content("~/Content/Back/Plug/bootstrap-table/bootstrap-table.js")"></script>*@
    @*<script src="@Url.Content("~/Content/Back/Plug/bootstrap-table/bootstrap-table-zh-CN.js")"></script>*@
    <script type="text/javascript">
        var PageDatas = {
            classify: [],
            tags: []
        },
            Action = {
                urlAddClassify: '@Url.Action("AddClassify", "Classify")',
                urlEditClassify: '@Url.Action("EditClassify", "Classify")',
                urlAddTag: '@Url.Action("AddTag", "Classify")',
                urlEditTag: '@Url.Action("EditTag", "Classify")',
                sourceClassify: '@Url.Content("~/Source/Sys/Images/")',
                sourceTag: '@Url.Content("~/Source/Sys/Images/")'
            };

        @if (Classifs != null)
        {
            foreach (var item in Classifs)
            {

                Write(new HtmlString(string.Format("PageDatas.classify.push({{ CName: '{0}',CIcon: '{1}',ClassifyId: '{2}'}});", item.CName, item.CIcon, item.ClassifyId)));
                //Write(string.Format("大家好{0}", "linkFly"));
            }
        }

        require.config({
            baseUrl: '/Content/Back/JavaScript',
            paths: {
                'so': 'so/so',
                'classify': 'said/classify',
                'bsTable': ['../Plug/bootstrap-table/bootstrap-table'],
                'upload': ['so/plug/upload'],
                'bsTable-cn': ['../Plug/bootstrap-table/bootstrap-table-zh-CN']
            },
            packages: [
            {
                name: 'said',
                location: 'said',
                main: 'said'
            }], shim: {
                'bsTable-cn': ['bsTable']
            }
        });
        require(['so', 'jquery', 'classify', 'upload', 'bsTable-cn'], function (so, $, Extend) {
            $(function () {
                'use strict';
                var $window = $(window),
                    SaidTable = function ($bsTable, editEventCallback, deleteEventCallback, addCallback, editCallback) {
                        var $forms = $bsTable.find('.data-form'),//[新增表单、编辑表单]
                            toggleForm = function (index) {
                                $forms.eq(index ^ 1).hide(0).end().eq(index).show(0);
                            },
                            $addInput = $forms.eq(0).find('input'),//添加分类的输入框[iconText]
                            $editInput = $forms.eq(1).find('input'),//编辑分类的输入框[iconText]
                            $table = $bsTable.find('.main-table'),
                            globalEdit = {
                                //id: '',
                                //name,
                                //img: '',
                                //index:''
                            };
                        //监听页面编辑事件
                        $table.on('click', '.data-edit', function (e) {
                            $.each(this.dataset, function (name, value) {
                                globalEdit[name] = value;
                            });
                            editEventCallback.call(this, $editInput, globalEdit);
                            toggleForm(1);
                        }).on('click', '.data-delete', function (e) {
                            globalEdit = {};
                            deleteEventCallback.call(this, this.dataset);
                        });
                        $forms.eq(0).find('button').click(function () {
                            //新增按钮
                            addCallback.call($addInput[0], $addInput, globalEdit);
                        }).end().end().eq(1).find('button')
                            .eq(0).click(function () {
                                //编辑按钮
                                editCallback.call($editInput[0], $editInput, globalEdit);
                            }).end().eq(1).click(function () {//取消
                                //取消按钮
                                toggleForm(0);
                                globalEdit = {};
                            });
                        return {
                            $forms: $forms,
                            $table: $table,
                            $add: $addInput,
                            $edit: $editInput,
                            toggle: toggleForm
                        };
                    };
                var $bsTables = $('.bs-table');

                (function ($bsTable) {
                    //分类编辑逻辑
                    var classifyData = SaidTable($bsTable, function ($editInput, data) {
                        setEditInputData(data);
                    },
                    function (data) {
                        //删除分类事件
                        classifyData.toggle(0);
                    },
                    function ($addInput) {
                        var data = $addInput.uploadText();
                        //TODO
                        if (!data.value || !data.value.trim()) $addInput.focus();
                        //ajax添加
                        $.ajax(Action.urlAddClassify, {
                            type: 'post',
                            dataType: 'json',
                            contentType: 'application/json',
                            data: JSON.stringify({ name: data.value, imgName: data.img }),
                        }).done(function (server) {
                            if (server.code === 0) {
                                $classifyTable.bootstrapTable('append', [{
                                    CName: data.value,
                                    CIcon: data.img,
                                    ClassifyId: server.data
                                }]);
                            } else {
                                console.group('服务器错误');
                                console.log(server.code);
                                console.log(arguments);
                                console.groupEnd();
                            }
                        }).fail(function () {
                            console.group('ajax错误');
                            console.log(arguments);
                            console.groupEnd();
                        });

                    }, function ($editInput) {
                        var data = $editInput.uploadText();
                        console.log(data);
                        if (!data.value || !data.value.trim()) $editInput.focus();

                    }),
                    setEditInputData = function (data) {//设置编辑框的数据
                        if (data.id) {
                            classifyData.$edit.uploadText({
                                value: data.name,
                                img: data.icon
                            });
                        }
                    },
                    checkData = function ($elem) {
                        var data = $elem.uploadText();
                    };
                    classifyData.$add.uploadText({
                        fail: function (error) {
                            classifyData.$add.popover({
                                placement: 'bottom',
                                content: error.msg,
                                title: '上传异常',
                                trigger: 'focus'
                            }).popover('show');
                            $window.one('click', function () {
                                classifyData.$add.popover('destroy');
                            });
                        }
                    });
                    classifyData.$edit.uploadText({
                        fail: function (error) {
                            classifyData.$edit.popover({
                                placement: 'bottom',
                                content: error.msg,
                                title: '上传异常',
                                trigger: 'manual'
                            }).popover('show');
                            $window.one('click', function () {
                                classifyData.$edit.popover('destroy');
                            });
                        }
                    });

                })($bsTables.eq(0));

                (function ($bsTable) {
                    //标签
                    var tagData = SaidTable($bsTable, function ($editInput, data) {
                        $editInput.val(data.name);
                    }, function (data) {
                        tagData.toggle(0);
                    }, function ($addInput, data) {
                        alert('新增标签');
                    }, function ($editInput, data) {
                        alert('编辑标签');
                    });

                })($bsTables.eq(1));

                var $classifyTable = $('#classifyTable').bootstrapTable({
                    columns: [
                    {
                        field: 'CName',
                        title: '名称',
                        align: 'left',
                        valign: 'bottom',
                        sortable: true
                    },
                    {
                        field: 'CIcon',
                        title: 'Icon',
                        align: 'left',
                        valign: 'bottom',
                        formatter: function (value) {
                            return ['<img src="', Action.sourceClassify + value, '" alt="" class="blog-other-icon"/>'].join('');
                        }

                    },
                    {
                        field: 'ClassifyId',
                        title: '操作',
                        align: 'center',
                        valign: 'bottom',
                        formatter: function (value, row, index) {
                            return ['<a class="btn btn-info icon-edit data-edit" href="javascript:;" data-id="', value, '"  data-index="', index, '" data-icon="', row.CIcon, '" data-name="', row.CName, '" title="编辑"></a><a class="btn btn-danger icon-trash data-delete" href="javascript:;" data="', value, '" title="删除"></a>'].join('');
                        }
                    }],
                    data: PageDatas.classify
                }).on('dbl-click-row.bs.table', function (e, row, $element) { });

                var $tagTable = $('#tagsTable').bootstrapTable({
                    columns: [
                    {
                        field: 'TTagName',
                        title: '名称',
                        align: 'left',
                        sortable: true
                    },
                    {
                        field: 'TTagId',
                        title: '操作',
                        align: 'center',
                        formatter: function (value, row, index) {

                            return ['<a class="btn btn-info icon-edit data-edit" href="javascript:;" data-id="', value, '" data-index="', index, '" data-name="', row.TTagName, '" title="编辑"></a><a class="btn btn-danger icon-trash data-delete" href="javascript:;" data="', value, '" title="删除"></a>'].join('');
                            //return ['<a class="btn btn-warning icon-edit data-save" href="javascript:;" data-id="', value, '" title="保存"></a><a class="btn btn-info icon-trash data-cancel" href="javascript:;" data="', value, '" title="取消"></a>'].join('');
                        }
                    }],
                    data: [
                        {
                            TTagName: 'ECMAScript 6',
                            TTagId: '136116aa-a5f6-4f88-bcc4-00a1b4db0dba'
                        },
                        {
                            TTagName: 'RequireJS',
                            TTagId: '271f2924-69ce-4522-8e39-cc8f31059de8'
                        },
                        {
                            TTagName: 'JavaScript',
                            TTagId: '2e0dfa2f-dca4-4e1a-abeb-889ce98a8bb0'
                        },
                        {
                            TTagName: '.NET',
                            TTagId: '6198f526-fa0f-4429-983a-bebc8439e7c8'
                        },
                        {
                            TTagName: 'CSS',
                            TTagId: '817aa0f0-447e-46d3-805c-8952c0332df8'
                        },
                        {
                            TTagName: 'jQuery',
                            TTagId: 'ac11966d-01bf-4554-bd7e-7e0a807ea8fa'
                        },
                        {
                            TTagName: 'ECMAScript 5',
                            TTagId: 'd2774f82-3f56-4b0a-b3ae-0ad203cdc510'
                        }
                    ]

                }).bootstrapTable('updateRow', {
                    index: 2,
                    row: {
                        TTagName: '这是更新的啊啊',
                        TTagId: 'ac11966d-01bf-4554-bd7e-7e0a807ea8fa'
                    }
                });
            });

        });
    </script>
}
